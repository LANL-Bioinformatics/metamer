#!/usr/bin/env python

"""
metamash pipeline

wrapper for metamash

"""


import os
import sys
import argparse
import luigi
dir_path = os.path.dirname(os.path.realpath(__file__))
lib_path = os.path.abspath(os.path.join(dir_path, '..'))
bin_path = os.path.join(lib_path, 'bin')
sys.path.append(lib_path)
os.environ["PATH"] += os.pathsep + bin_path
from luigi.interface import build
from metamash import parse_metainput, create_sketch, calc_dist


def cmdline_parser():
    """
    Create an argparse instance.

    Combination of different options for this script.
    """
    class CustomFormatter(argparse.ArgumentDefaultsHelpFormatter,
                          argparse.RawDescriptionHelpFormatter):
        """For multiple formatters of argparse."""

        pass

    parser = argparse.ArgumentParser(formatter_class=CustomFormatter,
                                     prog='runPiReT',
                                     description="""RNASeq workflow""",
                                     epilog="""
It requires a metadata table that contains information regarding metagenome
samples

""")

    parser.add_argument("-t", dest="THREADS", help="""number of CPUs/threads to
                         run per task.""",
                        required=False, default=1)

    required_args = parser.add_argument_group('required arguments')

    required_args.add_argument("-d", dest="WORKDIR", help="""working directory where all
        output files will be processed and written""", required=True)

    required_args.add_argument("-m", dest="META", help="""tab delimited meta
        data file""", required=True, default=argparse.SUPPRESS)

    # required_args.add_argument("-f", dest="FOLDER", help="""path to folder
        # with data""", required=True, default=argparse.SUPPRESS)

    parser.add_argument('--version', action='version', version='%(prog)s 0.0.0')
    parser.add_argument("-k", dest="KMER", help="""k-mer size to set.""",
                        required=False, default=21)
    parser.add_argument("-e", dest="SEED", help="""seed to set.""",
                        required=False, default=547)
    parser.add_argument("-n", dest="MIN", help="""minimum number of copy.""",
                        required=False, default=2)
    parser.add_argument("-s", dest="SKETCH", help="""sketch size""", required=False,
                        default=1000)

    return parser


def main():
    """
    Main function.

    All functions are called here.
    """
    parser = cmdline_parser()
    args = parser.parse_args()

    # Getting absolute path of some directories
    workdir = os.path.abspath(args.WORKDIR)
    bindir = os.path.abspath(os.path.join(dir_path, '..', 'bin'))
    os.environ['PATH'] = os.environ['PATH'] + ":" + bindir
    
    fq_dt = parse_metainput.parse_meta(args.META)

    for sample, fastq in fq_dt.items():
        if len(fastq) > 1:
            build([create_sketch.CreateReadSketches(read1=os.path.join(args.WORKDIR, fastq[0]),
                                                    read2=os.path.join(args.WORKDIR, fastq[1]),
                                                    smp=sample,
                                                    kmer=args.KMER,
                                                    threads=args.THREADS,
                                                    sketch=args.SKETCH,
                                                    seed=args.SEED,
                                                    min_copy=args.MIN,
                                                    out_dir=args.WORKDIR)],
            local_scheduler = True, workers=1)
            print(args.WORKDIR)
            build([calc_dist.CalculateDist(threads=args.THREADS,
                                            sk_dir=args.WORKDIR,
                                            out_file="test.txt")],
            local_scheduler = True, workers=1)




if __name__ == '__main__':
    main()
